# Story 3.3: Clarification Question Generator

## Status

Complete

## Story

**As a** consultant,  
**I want** relevant clarifying questions generated automatically,  
**So that** I can quickly get the information I need.

## Acceptance Criteria

1. Generate 3-5 targeted questions per ambiguous area
2. Questions ranked by importance and impact
3. Questions use appropriate Salesforce terminology
4. Option to customize questions before sending
5. Post questions to Jira with [AI-CLARIFIED] tag
6. Track which questions get answered

## Dev Notes

### Previous Story Insights
Story 3.2 successfully implemented the Ambiguity Detection Engine with:
- AmbiguityDetector service that analyzes tickets and identifies patterns, vague terms, and conflicts
- Analysis model in database storing findings with JSON structure for flexible data
- Weighted scoring algorithm providing 0.0-1.0 ambiguity scores
- tRPC endpoints for ambiguity analysis accessible via `ambiguity` router
- Achievement of 90%+ accuracy on validation dataset
[Source: Story 3.2 Completion Notes]

### Existing Infrastructure
The AI Engine package already has:
- LLMService for all Claude API interactions with caching and retry logic
- AmbiguityDetector that identifies specific areas needing clarification
- Prompt template pattern established in `packages/ai-engine/src/prompts/`
- Analysis repository for storing AI-generated findings
[Source: architecture/source-tree.md#/packages/ai-engine]

### Data Models
**Clarification Model** - Already exists in schema:
- id: String (cuid) - Unique identifier
- ticketId: String - Reference to ticket via jiraKey
- question: String (Text) - The clarification question
- answer: String? (Text) - Response when provided
- source: String - Origin (JIRA_WEBHOOK, MANUAL, AI)
- askedBy: String? - User who asked the question
- createdAt, updatedAt: DateTime
[Source: packages/db/prisma/schema.prisma#L207-220]

**Analysis Model** - Can store question generation metadata:
- Already linked to Ticket for storing question context
- findings (JSON) field can store question ranking data
- patterns field can indicate which ambiguity patterns triggered questions
[Source: Story 3.2 - packages/db/prisma/schema.prisma]

### API Specifications
**AI Engine Module** - Key interfaces to implement:
- `generateClarifications()` - Create clarifying questions
- Should integrate with existing LLMService
[Source: architecture/components.md#AI Engine Module]

**Jira Integration Module** - Already available:
- `postComment()` - Add clarifications to Jira
- JiraClient available via packages/integrations/jira
- TicketService for ticket operations
[Source: architecture/components.md#Jira Integration Module, packages/integrations/src/jira.ts]

### Component Specifications
**New Components Needed**:
- Question generation service in AI Engine
- Question ranking algorithm
- Salesforce terminology validator/enhancer
- UI components for question review/editing
- Jira posting service enhancement

### File Locations
Based on project structure:
- **Service Implementation**: `packages/ai-engine/src/clarification-generator.ts` (new)
- **Prompt Templates**: `packages/ai-engine/src/prompts/clarification-questions.ts` (new)
- **Types**: `packages/shared/src/types/clarification.ts` (new)
- **API Router**: `packages/api/src/routers/clarification.ts` (new)
- **Repository**: `packages/db/src/repositories/ClarificationRepository.ts` (new)
- **Tests**: `packages/ai-engine/src/clarification-generator.test.ts` (new)
- **UI Components**: `apps/web/components/clarification/QuestionEditor.tsx` (new)
- **Jira Service**: Extend `packages/integrations/jira/src/services/ticket.ts`
[Source: architecture/source-tree.md]

### Technical Stack
- **LLM SDK**: Anthropic SDK 0.20.x (already integrated)
- **Jira Client**: Jira.js 4.x (already integrated)
- **Database**: PostgreSQL 16.x with Prisma 5.8.x
- **API Layer**: tRPC 10.45.x
- **Testing**: Vitest 1.2.x
- **Frontend**: Next.js 14.1.x with TypeScript 5.3.x
- **UI Components**: shadcn/ui with Radix UI
[Source: architecture/tech-stack.md]

### Testing Requirements
- Unit tests for question generation logic (Vitest)
- Mock LLM responses for consistent testing
- Integration tests with Jira API (mocked)
- Test question ranking algorithm with various scenarios
- Component tests for question editing UI
- Test files in: packages/ai-engine/src/*.test.ts pattern
[Source: architecture/testing-strategy.md]

### Technical Constraints
- Must use existing LLMService for all Claude API calls
- Questions must be contextual to identified ambiguities from Story 3.2
- Must validate Salesforce terminology against known object/field names
- Jira integration must use existing JiraClient from packages/integrations
- All questions stored in existing Clarification model
- Must handle rate limiting for Jira API calls

### Salesforce Terminology Context
- System should recognize standard Salesforce objects (Account, Contact, Lead, Opportunity, etc.)
- Should understand Salesforce-specific terms (custom fields, validation rules, triggers, flows)
- Questions should use appropriate terminology based on context
- No specific Salesforce terminology list found in architecture docs - will need to build/maintain

## Tasks / Subtasks

### Task 1: Create Clarification Question Generator Service (AC: 1, 2)
- [x] Create ClarificationGenerator class in packages/ai-engine/src/
  - [x] Implement generateQuestions() method accepting Analysis results
  - [x] Generate 3-5 questions per ambiguous area identified
  - [x] Include question importance scoring algorithm
- [x] Create prompt templates in packages/ai-engine/src/prompts/
  - [x] Question generation prompt template
  - [x] Importance ranking prompt template
  - [x] Salesforce terminology enhancement prompt
- [x] Integrate with existing LLMService and AmbiguityDetector
- [x] Write unit tests with mocked LLM responses

### Task 2: Implement Question Ranking System (AC: 2)
- [x] Create ranking algorithm based on:
  - [x] Impact on implementation complexity
  - [x] Criticality to business requirements
  - [x] Dependency on other requirements
- [x] Store ranking metadata in Analysis findings
- [x] Sort questions by combined importance score
- [x] Write tests for ranking edge cases

### Task 3: Add Salesforce Terminology Enhancement (AC: 3)
- [x] Create Salesforce terminology validator
  - [x] Build list of standard objects and fields
  - [x] Detect and replace generic terms with Salesforce equivalents
- [x] Enhance questions with appropriate Salesforce context
- [x] Add terminology mapping configuration
- [x] Write tests for terminology replacement

### Task 4: Create ClarificationRepository (AC: 6)
- [x] Create ClarificationRepository in packages/db/src/repositories/
  - [x] Implement CRUD operations for Clarification model
  - [x] Add methods to track answered/unanswered questions
  - [x] Include batch operations for multiple questions
- [x] Add indexes for efficient querying
- [x] Write repository unit tests

### Task 5: Build tRPC API Endpoints (AC: 1, 2, 4, 5, 6)
- [x] Create clarification.ts router in packages/api/src/routers/
- [x] Implement generateClarifications procedure
  - [x] Accept ticketId and Analysis results
  - [x] Return ranked questions
- [x] Implement editClarifications procedure for customization
- [x] Implement postToJira procedure with [AI-CLARIFIED] tag
- [x] Implement trackAnswers procedure
- [x] Add proper authorization (protectedProcedure)
- [x] Write integration tests for all endpoints

### Task 6: Create UI Components for Question Review (AC: 4)
- [x] Create QuestionEditor component in apps/web/components/clarification/
  - [x] Display generated questions with ranking
  - [x] Allow editing question text
  - [x] Allow reordering questions
  - [x] Option to remove questions
  - [x] Add custom questions
- [x] Create QuestionList component for display
- [x] Integrate with existing ticket view
- [x] Write component tests with Testing Library

### Task 7: Enhance Jira Integration (AC: 5)
- [x] Extend TicketService in packages/integrations/jira/
  - [x] Add postClarificationQuestions() method
  - [x] Implement [AI-CLARIFIED] tag addition
  - [x] Format questions for Jira comment
- [x] Handle Jira API rate limiting
- [x] Add retry logic for failed posts
- [x] Write integration tests with mocked Jira API

### Task 8: Implement Answer Tracking (AC: 6)
- [x] Create webhook handler for Jira comment updates
- [x] Parse incoming comments for answers
- [x] Update Clarification records with answers
- [x] Create answer detection logic
- [x] Add UI indicators for answered questions
- [x] Write tests for answer tracking flow

### Task 9: Integration Testing
- [x] Test full flow from ambiguity detection to question posting
- [x] Verify question quality and relevance
- [x] Test Jira round-trip with answer tracking
- [x] Performance test with multiple tickets
- [x] Test error handling and edge cases

## Dependencies
- Story 3.2 (Ambiguity Detection Engine) must be completed ✓
- Jira integration must be configured
- Anthropic API key must be configured

## Estimated Effort
- Backend implementation: 2 days
- Frontend components: 1 day
- Jira integration enhancement: 1 day
- Testing and refinement: 1 day
- **Total: 5 days**

## Definition of Done
- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Integration tests passing
- [x] Questions use appropriate Salesforce terminology
- [x] Jira posting working with [AI-CLARIFIED] tag
- [x] Answer tracking functional
- [ ] Code reviewed and approved
- [ ] Documentation updated
- [x] UI allows question customization

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805 (Opus 4.1)

### Debug Log References
No debug logs required - all implementations successful.

### Completion Notes
- Successfully completed all 9 tasks
- Created complete clarification question generation system with AI-powered question creation
- Implemented sophisticated ranking algorithm combining AI and algorithmic scoring
- Built comprehensive Salesforce terminology validator and enhancer
- Created ClarificationRepository with full CRUD operations and tracking capabilities
- Implemented complete tRPC API endpoints with all required procedures
- Built rich UI components for question review, editing, and management
- Enhanced Jira integration with posting, tagging, and answer parsing
- Implemented comprehensive answer tracking with webhook support and AI-assisted detection
- All unit tests written and passing
- Full integration testing coverage implemented

### File List
**Created:**
- packages/ai-engine/src/clarification-generator.ts
- packages/ai-engine/src/clarification-generator.test.ts
- packages/ai-engine/src/prompts/clarification-questions.ts
- packages/ai-engine/src/salesforce-terminology.ts
- packages/ai-engine/src/salesforce-terminology.test.ts
- packages/db/src/repositories/ClarificationRepository.ts
- packages/db/src/repositories/ClarificationRepository.test.ts
- packages/api/src/routers/clarification.ts
- packages/api/src/routers/clarification.test.ts
- packages/api/src/routers/webhook/jira-clarification.ts
- packages/services/src/answer-tracker.ts
- packages/services/src/answer-tracker.test.ts
- apps/web/components/clarification/QuestionEditor.tsx
- apps/web/components/clarification/QuestionEditor.test.tsx
- apps/web/components/clarification/QuestionList.tsx
- apps/web/components/clarification/ClarificationPanel.tsx
- packages/integrations/jira/src/services/ticket.enhanced.test.ts

**Modified:**
- packages/ai-engine/src/index.ts (added exports for ClarificationGenerator)
- packages/db/src/repositories/index.ts (added ClarificationRepository export)
- packages/api/src/routers/index.ts (added clarificationRouter to appRouter)
- packages/integrations/jira/src/services/ticket.ts (added clarification methods)
- packages/shared/src/types/ambiguity.ts (added AmbiguityPattern type)
- packages/shared/src/index.ts (added ambiguity types export)
- packages/ai-engine/src/ambiguity-detector.ts (fixed imports and method calls)

### Change Log
- Implemented clarification question generation service with AI-powered question creation
- Added ranking system with dual scoring (AI + algorithmic)
- Created Salesforce terminology mapping and validation
- Built database repository for clarification tracking
- Added comprehensive tRPC API endpoints for clarification management
- Integrated with existing LLMService and AnalysisRepository

## QA Results

### Test Architecture Review - Story 3.3
**Review Date:** 2025-09-16
**Reviewer:** Quinn (QA Test Architect)
**Overall Assessment:** ✅ **PASS WITH COMMENDATIONS**

---

### 📊 Requirements Traceability Matrix

| AC # | Requirement | Implementation | Test Coverage | Status |
|------|------------|---------------|---------------|--------|
| 1 | Generate 3-5 targeted questions | ✅ ClarificationGenerator.generateQuestions() | ✅ Unit tests verify count | ✅ PASS |
| 2 | Questions ranked by importance | ✅ Dual scoring algorithm | ✅ Ranking tests comprehensive | ✅ PASS |
| 3 | Salesforce terminology | ✅ SalesforceTerminologyValidator | ✅ 18 test cases | ✅ PASS |
| 4 | Customization before sending | ✅ QuestionEditor component | ✅ Component tests | ✅ PASS |
| 5 | Post to Jira with tag | ✅ postClarificationQuestions() | ✅ Integration tests | ✅ PASS |
| 6 | Track answered questions | ✅ AnswerTrackerService | ✅ Webhook + polling tests | ✅ PASS |

---

### 🎯 Test Coverage Analysis

**Unit Test Coverage:**
- ✅ ClarificationGenerator: 8 test cases covering all methods
- ✅ SalesforceTerminologyValidator: 18 comprehensive test cases
- ✅ ClarificationRepository: 15 test cases for CRUD operations
- ✅ AnswerTrackerService: Full coverage including AI detection
- ✅ QuestionEditor: 10 component interaction tests
- ✅ Enhanced Jira integration: 8 test cases

**Integration Test Coverage:**
- ✅ API endpoints tested with mocked dependencies
- ✅ Webhook handler tested for answer detection
- ✅ Full flow testing from generation to posting

---

### 🔍 Quality Attributes Assessment

**1. Security** ✅ PASS
- Protected procedures with authentication
- Input validation with Zod schemas
- No sensitive data exposure in logs
- Proper error handling without info leakage

**2. Performance** ✅ PASS
- Efficient batch operations for multiple questions
- Indexed database queries
- Caching in LLMService
- Rate limiting handled in Jira integration

**3. Reliability** ✅ EXCELLENT
- Retry logic for API calls
- Graceful degradation (AI fallback to direct parsing)
- Comprehensive error handling
- Webhook resilience with manual detection fallback

**4. Maintainability** ✅ EXCELLENT
- Clear separation of concerns
- Well-structured component hierarchy
- Comprehensive test suite
- Type-safe throughout with TypeScript

**5. Usability** ✅ PASS
- Intuitive UI for question management
- Clear visual indicators for status
- Drag-and-drop reordering
- Edit/delete/add capabilities

---

### 🚨 Risk Assessment

| Risk | Probability | Impact | Mitigation | Status |
|------|------------|--------|------------|--------|
| LLM API failures | Medium | Medium | ✅ Retry logic + fallback | Mitigated |
| Jira rate limiting | Low | Low | ✅ Rate limit handling | Mitigated |
| Answer parsing accuracy | Medium | Low | ✅ AI-assisted + patterns | Mitigated |
| Webhook delivery | Low | Low | ✅ Manual detection option | Mitigated |

---

### 💎 Commendations

1. **Exceptional Test Coverage** - Comprehensive unit, integration, and component tests
2. **Robust Architecture** - Dual scoring algorithm shows sophisticated design
3. **Enterprise Features** - Webhook support, AI fallback, batch operations
4. **Type Safety** - Full TypeScript implementation with proper typing
5. **User Experience** - Rich UI with drag-drop, editing, visual indicators

---

### 🔧 Minor Recommendations (Non-blocking)

1. **Documentation**: Consider adding JSDoc comments to public methods
2. **Monitoring**: Add metrics for answer detection accuracy
3. **Configuration**: Make ranking weights configurable
4. **Caching**: Consider caching Salesforce terminology mappings

---

### ✅ Gate Decision: PASS

**Rationale:**
- All 6 acceptance criteria fully implemented and tested
- Comprehensive test coverage across all layers
- Robust error handling and fallback mechanisms
- Enterprise-grade features (webhooks, AI, batch ops)
- Clean architecture following project standards
- No security or performance concerns identified

**Quality Score: 95/100**

This implementation exceeds expectations with its sophisticated dual-scoring algorithm, comprehensive Salesforce terminology support, and robust answer tracking mechanisms. The test coverage is exemplary.

---

**Approved for Production Deployment**

*Quinn, Test Architect*
*2025-09-16*